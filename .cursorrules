# SPT 4.0 Mod Project

This is a modding project for **SPT Tarkov 4.0**.

## Project Purpose

This mod is titled `BewasModSync`. It's purpose is simple- to give SPT server owners an easy way to ensure their clients can download their mods easily, and so that required mods are enforced on clients. Other mods have accomplished similar goals (see `reference_NarcoNetModSync` directory), but I find them to be a little convoluted. Our main goal here is to set up a simple system that makes it hard for the user to make mistakes.

### Primary mod components:

#### Server component

**JSON CONFIGURATION FILE**
Server side configuration file (.json), which has the mod list, and any other important data for future stretch goals.

This file is the source of truth for all settings on the server side. This configuration file will be loaded and saved by a web UI component.

The main data point of this config file will be the property `modList`. See `reference_serverConfig.jsonc` for more info.

**WEB UI**
This UI can be spun up on SPT server start. See `reference_ProgressionTracker` directory for an example of a simple mod with a UI component which saves to a configuration file.

#### Client component

At some point we have to ping the server to get the current mod list data. This can be done via a manual, `.exe`, `.bat`, or similar. This would open up a (preferably pretty colored) command prompt with progress on what it's doing.

The client component needs to have a local `modsDownloaded.json` file, which keeps track of what mods were downloaded and extra data. See `reference_modsDownloaded` for more info.

## Project Structure

```
ModName/
├── Client/                        # BepInEx client plugin (runs in-game)
│   ├── ModName.cs                 # Main client code - Harmony patches
│   ├── ModName.csproj             # .NET Framework 4.7.1 project
│   └── Assets/                    # Config files, sprites, asset bundles
│
├── Server/                        # SPT C# server mod (runs on backend)
│   ├── ModNameBackend.cs          # Main server code - data handlers
│   ├── ModNameRouter.cs           # HTTP route handlers
│   └── ModNameBackend.csproj      # .NET 9.0 project
│
├── dist/                          # Build output (gitignored)
│   ├── BepInEx/plugins/ModName/   # Client mod output
│   └── SPT/user/mods/ModName/     # Server mod output
│
└── ModName.sln                    # Visual Studio solution
```

## Creating a New Project

### 1. Create Solution Structure

```bash
mkdir ModName
cd ModName
mkdir Client Server
```

### 2. Create Server Project (.NET 9.0)

Create `Server/ModNameBackend.csproj`:

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">
    <PropertyGroup>
        <TargetFramework>net9.0-windows</TargetFramework>
        <RootNamespace>ModName</RootNamespace>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <OutputType>Library</OutputType>
        <Version>1.0.0</Version>
        <AppendTargetFrameworkToOutputPath>false</AppendTargetFrameworkToOutputPath>
        <AppendRuntimeIdentifierToOutputPath>false</AppendRuntimeIdentifierToOutputPath>
        <PlatformTarget>x64</PlatformTarget>
        <!-- Clean output -->
        <DebugType>none</DebugType>
        <DebugSymbols>false</DebugSymbols>
        <ProduceReferenceAssembly>false</ProduceReferenceAssembly>
        <CopyLocalLockFileAssemblies>false</CopyLocalLockFileAssemblies>
    </PropertyGroup>

    <PropertyGroup>
        <OutputPath>..\dist\SPT\user\mods\ModNameBackend\</OutputPath>
    </PropertyGroup>

    <!-- Update this to your SPT installation path -->
    <PropertyGroup>
        <SPTPath>C:\SPT</SPTPath>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="SPTarkov.Common" Version="4.0.0" PrivateAssets="all" />
        <PackageReference Include="SPTarkov.DI" Version="4.0.0" PrivateAssets="all" />
        <PackageReference Include="SPTarkov.Server.Core" Version="4.0.0" PrivateAssets="all" />
    </ItemGroup>

    <!-- Optional: Copy to SPT for testing -->
    <Target Name="CopyToSPT" AfterTargets="Build" Condition="Exists('$(SPTPath)')">
        <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(SPTPath)\SPT\user\mods\ModNameBackend" />
    </Target>
</Project>
```

### 3. Create Client Project (.NET Framework 4.7.1)

Create `Client/ModName.csproj`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')" />
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
    <OutputType>Library</OutputType>
    <RootNamespace>ModName</RootNamespace>
    <AssemblyName>ModName</AssemblyName>
    <TargetFrameworkVersion>v4.7.1</TargetFrameworkVersion>
    <LangVersion>7.3</LangVersion>
    <!-- Clean output -->
    <DebugType>none</DebugType>
    <DebugSymbols>false</DebugSymbols>
    <AutoGenerateBindingRedirects>false</AutoGenerateBindingRedirects>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
    <OutputPath>..\dist\BepInEx\plugins\ModName\</OutputPath>
  </PropertyGroup>
  <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <OutputPath>..\dist\BepInEx\plugins\ModName\</OutputPath>
  </PropertyGroup>

  <!-- Update this to your SPT installation path -->
  <PropertyGroup>
    <SPTPath>C:\SPT</SPTPath>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="ModName.cs" />
    <Compile Include="Properties\AssemblyInfo.cs" />
  </ItemGroup>

  <!-- Reference assemblies from SPT installation (Private=false prevents copying) -->
  <ItemGroup>
    <Reference Include="0Harmony">
      <HintPath>$(SPTPath)\BepInEx\core\0Harmony.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="Assembly-CSharp">
      <HintPath>$(SPTPath)\EscapeFromTarkov_Data\Managed\Assembly-CSharp.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="BepInEx">
      <HintPath>$(SPTPath)\BepInEx\core\BepInEx.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="Comfort">
      <HintPath>$(SPTPath)\EscapeFromTarkov_Data\Managed\Comfort.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="Newtonsoft.Json">
      <HintPath>$(SPTPath)\EscapeFromTarkov_Data\Managed\Newtonsoft.Json.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="spt-common">
      <HintPath>$(SPTPath)\BepInEx\plugins\spt\spt-common.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="System"><Private>false</Private></Reference>
    <Reference Include="UnityEngine">
      <HintPath>$(SPTPath)\EscapeFromTarkov_Data\Managed\UnityEngine.dll</HintPath>
      <Private>false</Private>
    </Reference>
    <Reference Include="UnityEngine.CoreModule">
      <HintPath>$(SPTPath)\EscapeFromTarkov_Data\Managed\UnityEngine.CoreModule.dll</HintPath>
      <Private>false</Private>
    </Reference>
  </ItemGroup>

  <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />

  <!-- Clean up unwanted files -->
  <Target Name="CleanupOutput" AfterTargets="Build">
    <ItemGroup>
      <FilesToDelete Include="$(OutputPath)System.*.dll" />
      <FilesToDelete Include="$(OutputPath)*.pdb" />
      <FilesToDelete Include="$(OutputPath)*.config" />
    </ItemGroup>
    <Delete Files="@(FilesToDelete)" />
  </Target>

  <!-- Optional: Copy to SPT for testing -->
  <Target Name="CopyToSPT" AfterTargets="CleanupOutput" Condition="Exists('$(SPTPath)')">
    <Copy SourceFiles="$(OutputPath)ModName.dll" DestinationFolder="$(SPTPath)\BepInEx\plugins\ModName" />
  </Target>
</Project>
```

### 4. Create Solution File

Create `ModName.sln`:

```
Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.0.31903.59
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "ModName", "Client\ModName.csproj", "{GENERATE-NEW-GUID}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "ModNameBackend", "Server\ModNameBackend.csproj", "{GENERATE-NEW-GUID}"
EndProject
Global
    GlobalSection(SolutionConfigurationPlatforms) = preSolution
        Debug|Any CPU = Debug|Any CPU
        Release|Any CPU = Release|Any CPU
    EndGlobalSection
EndGlobal
```

### 5. Create .gitignore

Add to `.gitignore`:

```
# Build output
dist/
[Bb]in/
[Oo]bj/
*.pdb
*.dll

# IDE
.vs/
.idea/
*.user
```

## Building the Project

### Prerequisites

- Visual Studio 2022 or later (or `dotnet` CLI + MSBuild)
- .NET 9.0 SDK (for Server)
- .NET Framework 4.7.1 Developer Pack (for Client)
- SPT 4.0 installation (for reference DLLs)

### Configuration

Update `$(SPTPath)` in both `.csproj` files to match your SPT installation path. (C:/SPT)

### Build Commands

```bash
# Build entire solution
dotnet build ModName.sln

# Build server only
dotnet build Server/ModNameBackend.csproj

# Build client only (may need MSBuild)
msbuild Client/ModName.csproj
```

### Build Output

```
dist/
├── SPT/user/mods/ModNameBackend/
│   └── ModNameBackend.dll
│
└── BepInEx/plugins/ModName/
    └── ModName.dll
```

Please ensure `dist` directory contains files ONLY needed for end users.

### Installation

Copy contents of `dist/` to your SPT installation, or configure `$(SPTPath)` for automatic copying during build.

## Useful Links

- SPT Modding Wiki: https://wiki.sp-tarkov.com/
- SPT C# Server Source: https://github.com/sp-tarkov/server-csharp
- SPT Server Mod Examples: https://github.com/sp-tarkov/server-mod-examples
- SPT Client Mod Examples: https://github.com/Jehree/SPTClientModExamples

## Technical Reference

### Server Mod Structure

```csharp
using SPTarkov.DI.Annotations;
using SPTarkov.Server.Core.Models.Spt.Mod;

namespace ModName;

// Required metadata (replaces package.json)
public record ModMetadata : AbstractModMetadata
{
    public override string ModGuid { get; init; } = "your-mod-guid";
    public override string Name { get; init; } = "ModName";
    public override string Author { get; init; } = "YourName";
    public override SemanticVersioning.Version Version { get; init; } = new("1.0.0");
    public override SemanticVersioning.Range SptVersion { get; init; } = new("~4.0.0");
    // ... other properties
}

// Main mod class
[Injectable(InjectionType = InjectionType.Singleton)]
public class ModNameServer : IOnLoad
{
    public Task OnLoad()
    {
        // Initialization code
        return Task.CompletedTask;
    }
}
```

### Client Mod Structure

```csharp
using BepInEx;
using HarmonyLib;

namespace ModName;

[BepInPlugin("your.mod.guid", "ModName", "1.0.0")]
public class ModNamePlugin : BaseUnityPlugin
{
    private void Start()
    {
        new Harmony("your.mod.guid").PatchAll();
        Logger.LogInfo("ModName loaded");
    }
}

[HarmonyPatch]
class SomePatch
{
    [HarmonyPatch(typeof(SomeClass), nameof(SomeClass.SomeMethod))]
    static void Postfix()
    {
        // Patch code
    }
}
```

### Common SPT Server Services

- `DatabaseServer` - Access game database tables
- `ProfileHelper` - Get/modify player profiles
- `QuestHelper` - Quest-related operations
- `TraderHelper` - Trader-related operations
- `ItemHelper` - Item-related operations
- `ConfigServer` - Access SPT config files

## Current Task

### MVP

**Please only start with MVP!** - we will iterate after this is complete

- Server
  - Serves `serverConfig.jsonc` to clients on request
  - Web UI
    - Page is spun up on server start
    - Button to add a new mod to the mod list
      - Flow:
        - Prompt for mod name and url
        - Downloads files to a "staging" directory (maybe show a loading indicator) - analyzes structure
          - Be sure to cache mod urls -> their path in the staging directory, so we don't have to redownload every time we open the UI. If the mod url has not been downloaded before, we download
        - If structure follows the standard pattern, auto-generate `syncPaths`
        - If structure does not follow the standard pattern, prompt user to edit `syncPaths`
        - Save button to save the mod to the list
    - Web UI lists all current mods in card format
    - Web UI saves all needed files (`serverConfig.jsonc`, `modCache`, etc) to a folder called `BewaModSyncData`
- Client
  - `.exe` or similar which opens command prompt and fetches server mod config, and updates local mods if necessary
  - Ability to select which optional mods are downloaded
  - Enforcement upon game start to verify they have all the mods downloaded. Maybe check all the non-optional `syncPaths` to verify the files exist.
    - Perhaps also confirm the clients `modsDownloaded.json` lines up with the server

### Stretch Goals

More will be added, but this gives you an idea of where we're headed

- A restart server button in the Web UI

## Known Issues
