@page "/bewasmodsync"
@layout MainLayout

@using BewasModSync.Models
@using BewasModSync.Services
@using Color = MudBlazor.Color

@inject ConfigService ConfigService
@inject ModDownloadService ModDownloadService
@inject ModInstallService ModInstallService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <!-- Header Section -->
    <MudPaper Class="pa-6 mb-4" Style="background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 55px;">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Style="color: var(--text-primary); font-weight: 700;">SPT Server Mod Manager</MudText>
                <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">
                    Add mods to be installed on your SPT server. Clients will automatically sync from the installed files on the server.
                </MudText>
            </div>
            <div class="d-flex gap-2">
                @if (ConfigService.HasPendingChanges())
                {
                    <MudButton Variant="Variant.Filled" 
                               StartIcon="@Icons.Material.Filled.PlayArrow" 
                               Color="Color.Success"
                               Style="font-weight: 600;"
                               OnClick="ApplyChanges"
                               Disabled="_isApplying">
                        @if (_isApplying)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Applying...</span>
                        }
                        else
                        {
                            <span>Apply Changes</span>
                        }
                    </MudButton>
                }
                <MudButton Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add" 
                           Color="Color.Primary"
                           Style="background: var(--accent-cyan); color: #000; font-weight: 600;"
                           OnClick="OpenAddModsDialog">
                    Add Mods
                </MudButton>
            </div>
        </div>
        
        @if (ConfigService.HasPendingChanges())
        {
            <MudAlert Severity="Severity.Warning" Class="mt-4" Dense="true">
                You have pending changes. Click "Apply Changes" to install/remove mods.
                @{
                    var pendingInstalls = ConfigService.Config.ModList.Count(m => m.Status == ModStatus.Pending);
                    var pendingRemovals = ConfigService.Config.ModList.Count(m => m.Status == ModStatus.PendingRemoval);
                }
                @if (pendingInstalls > 0)
                {
                    <span class="ml-2">üì¶ @pendingInstalls to install</span>
                }
                @if (pendingRemovals > 0)
                {
                    <span class="ml-2">üóëÔ∏è @pendingRemovals to remove</span>
                }
            </MudAlert>
        }
    </MudPaper>

    <!-- Stats Bar -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Extension" Style="color: var(--accent-cyan);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Total Mods</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: var(--accent-green);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count(m => m.Status == ModStatus.Installed)</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Installed</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Pending" Style="color: var(--accent-orange);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count(m => m.Status == ModStatus.Pending)</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Pending Install</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Lock" Style="color: var(--accent-red);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count(m => !m.Optional)</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Required</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Mod Cards -->
    @if (ConfigService.Config.ModList.Count == 0)
    {
        <MudPaper Class="pa-8 text-center" Style="background: var(--card-bg); border: 2px dashed var(--border-color); border-radius: 12px;">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Large" Style="color: var(--text-secondary); font-size: 4rem;" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: var(--text-secondary);">No mods configured yet</MudText>
            <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Click "Add Mods" to get started</MudText>
        </MudPaper>
    }
    else
    {
        <MudGrid>
            @foreach (var mod in ConfigService.Config.ModList)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudPaper Class="pa-4" Style="@GetModCardStyle(mod)">
                        <div class="d-flex justify-space-between align-start mb-3">
                            <div>
                                <MudText Typo="Typo.h6" Style="color: var(--text-primary); font-weight: 600;">@mod.ModName</MudText>
                                <div class="d-flex gap-1 flex-wrap mt-1">
                                    <MudChip T="string" Size="Size.Small" Style="@GetStatusChipStyle(mod.Status)">
                                        @GetStatusText(mod.Status)
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" 
                                             Style="@(mod.Optional ? "background: var(--accent-green); color: #000;" : "background: var(--accent-orange); color: #000;")">
                                        @(mod.Optional ? "Optional" : "Required")
                                    </MudChip>
                                </div>
                            </div>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true">
                                <MudMenuItem OnClick="@(() => EditMod(mod))">
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" /> Edit
                                </MudMenuItem>
                                @if (mod.Status == ModStatus.Installed)
                                {
                                    <MudMenuItem OnClick="@(() => ReinstallMod(mod))">
                                        <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" Class="mr-2" /> Reinstall
                                    </MudMenuItem>
                                }
                                <MudMenuItem OnClick="@(() => DeleteMod(mod))" Style="color: var(--accent-red);">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Class="mr-2" /> 
                                    @(mod.Status == ModStatus.Pending ? "Remove" : "Uninstall")
                                </MudMenuItem>
                            </MudMenu>
                        </div>

                        <MudText Typo="Typo.body2" Class="mono mb-2" Style="color: var(--text-secondary); word-break: break-all; font-size: 0.75rem;">
                            @TruncateUrl(mod.DownloadUrl)
                        </MudText>

                        <MudDivider Class="my-3" Style="border-color: var(--border-color);" />

                        <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            Updated: @FormatTimestamp(mod.LastUpdated)
                        </MudText>

                        <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color: var(--text-secondary);">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @mod.InstallPaths.Count install path(s)
                        </MudText>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<!-- Add Mods Dialog (Bulk) -->
<MudDialog @bind-Visible="_addDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = false, BackdropClick = false })">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="color: var(--text-primary);">
            @if (_addDialogStep == AddDialogStep.Input)
            {
                <span>Add Mods</span>
            }
            else if (_addDialogStep == AddDialogStep.Downloading)
            {
                <span>Downloading Mods...</span>
            }
            else
            {
                <span>Results</span>
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_addDialogStep == AddDialogStep.Input)
        {
            <MudText Typo="Typo.body2" Class="mb-4" Style="color: var(--text-secondary);">
                Enter direct download links (one per line or separated by whitespace). 
                Mod names will be auto-generated from filenames.
            </MudText>
            
            <MudTextField @bind-Value="_bulkUrls" 
                          Label="Download URLs" 
                          Variant="Variant.Outlined"
                          Lines="8"
                          Placeholder="https://github.com/example/mod/releases/download/v1.0/ModName.zip&#10;https://github.com/another/mod.7z"
                          Class="mb-4 mono" />
            
            <MudCheckBox @bind-Value="_bulkOptional" 
                         Label="Mark all as optional (not enforced on clients)"
                         Color="Color.Primary" />
        }
        else if (_addDialogStep == AddDialogStep.Downloading)
        {
            <div class="pa-4">
                <MudText Typo="Typo.body1" Class="mb-2" Style="color: var(--text-primary);">
                    Processing @(_currentDownloadIndex + 1) of @_urlsToProcess.Count
                </MudText>
                <MudProgressLinear Value="@((_currentDownloadIndex + 1) * 100.0 / _urlsToProcess.Count)" 
                                   Color="Color.Primary" 
                                   Rounded="true" 
                                   Size="Size.Large"
                                   Class="mb-4" />
                
                <MudText Typo="Typo.body2" Class="mono" Style="color: var(--text-secondary); word-break: break-all;">
                    @(_currentDownloadUrl ?? "Starting...")
                </MudText>
                
                @if (_downloadResults.Count > 0)
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: var(--text-secondary);">
                        Completed: @_downloadResults.Count(r => r.Success) succeeded, @_downloadResults.Count(r => !r.Success) failed
                    </MudText>
                }
            </div>
        }
        else if (_addDialogStep == AddDialogStep.Results)
        {
            <div class="pa-2">
                @{ 
                    var successes = _downloadResults.Where(r => r.Success).ToList();
                    var failures = _downloadResults.Where(r => !r.Success).ToList();
                }
                
                @if (successes.Count > 0)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        Successfully staged @successes.Count mod(s) for installation
                    </MudAlert>
                    
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: var(--accent-green);">
                        ‚úì Staged Mods (click "Apply Changes" to install)
                    </MudText>
                    <MudList T="string" Dense="true" Class="mb-4">
                        @foreach (var result in successes)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                                <MudText Style="color: var(--text-primary);">@result.ModName</MudText>
                                <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">
                                    @result.SuggestedInstallPaths.Count install path(s) configured
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
                
                @if (failures.Count > 0)
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">
                        Failed to download @failures.Count mod(s)
                    </MudAlert>
                    
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: var(--accent-red);">
                        ‚úó Failed Downloads
                    </MudText>
                    <MudList T="string" Dense="true">
                        @foreach (var result in failures)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                                <MudText Style="color: var(--text-primary); word-break: break-all; font-size: 0.85rem;">
                                    @TruncateUrl(result.Url)
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color: var(--accent-red);">
                                    @result.Error
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
            </div>
        }
    </DialogContent>
    <DialogActions>
        @if (_addDialogStep == AddDialogStep.Input)
        {
            <MudButton OnClick="CloseAddDialog" Variant="Variant.Text">Cancel</MudButton>
            <MudButton Color="Color.Primary" 
                       Variant="Variant.Filled"
                       Disabled="@(string.IsNullOrWhiteSpace(_bulkUrls))"
                       OnClick="ProcessBulkDownload">
                Download & Stage
            </MudButton>
        }
        else if (_addDialogStep == AddDialogStep.Downloading)
        {
            <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">
                Please wait...
            </MudText>
        }
        else if (_addDialogStep == AddDialogStep.Results)
        {
            <MudButton Color="Color.Primary" 
                       Variant="Variant.Filled"
                       OnClick="CloseAddDialog">
                Done
            </MudButton>
        }
    </DialogActions>
</MudDialog>

<!-- Edit Mod Dialog -->
<MudDialog @bind-Visible="_editDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="color: var(--text-primary);">Edit Mod</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_editModName" 
                      Label="Mod Name" 
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      Required="true" />
        
        <MudTextField Value="@_editDownloadUrl" 
                      Label="Download URL" 
                      Variant="Variant.Outlined"
                      Class="mb-4 mono"
                      ReadOnly="true"
                      HelperText="URL cannot be changed. Delete and re-add to use a different URL." />
        
        <MudCheckBox @bind-Value="_editIsOptional" 
                     Label="Optional mod (not enforced on clients)"
                     Color="Color.Primary"
                     Class="mb-4" />

        <MudText Typo="Typo.subtitle1" Class="mt-4 mb-2" Style="color: var(--text-primary); font-weight: 600;">
            Install Paths
        </MudText>
        
        @for (int i = 0; i < _editInstallPaths.Count; i++)
        {
            var index = i;
            <MudPaper Class="pa-3 mb-2" Style="background: var(--secondary-bg); border: 1px solid var(--border-color);">
                <MudGrid>
                    <MudItem xs="5">
                        <MudTextField @bind-Value="_editInstallPaths[index].Source" 
                                      Label="Source Path" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mono" />
                    </MudItem>
                    <MudItem xs="1" Class="d-flex align-center justify-center">
                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" />
                    </MudItem>
                    <MudItem xs="5">
                        <MudTextField @bind-Value="_editInstallPaths[index].Target" 
                                      Label="Target Path" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mono" />
                    </MudItem>
                    <MudItem xs="1" Class="d-flex align-center justify-center">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => RemoveEditInstallPath(index))" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        <MudButton Variant="Variant.Text" 
                   StartIcon="@Icons.Material.Filled.Add" 
                   Color="Color.Primary"
                   OnClick="AddEditInstallPath"
                   Class="mt-2">
            Add Install Path
        </MudButton>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEditDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(string.IsNullOrWhiteSpace(_editModName) || _editInstallPaths.Count == 0)"
                   OnClick="SaveEditMod">
            Save Changes
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- Apply Changes Result Dialog -->
<MudDialog @bind-Visible="_applyResultDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="color: var(--text-primary);">Apply Changes Result</MudText>
    </TitleContent>
    <DialogContent>
        @if (_applyResult != null)
        {
            @if (_applyResult.InstalledMods.Count > 0)
            {
                <MudAlert Severity="Severity.Success" Class="mb-3">
                    <MudText Typo="Typo.subtitle2">‚úì Installed @_applyResult.InstalledMods.Count mod(s):</MudText>
                    @foreach (var mod in _applyResult.InstalledMods)
                    {
                        <MudText Typo="Typo.body2" Class="ml-3">‚Ä¢ @mod</MudText>
                    }
                </MudAlert>
            }
            
            @if (_applyResult.QueuedForInstall.Count > 0)
            {
                <MudAlert Severity="Severity.Info" Class="mb-3">
                    <MudText Typo="Typo.subtitle2">üì¶ @_applyResult.QueuedForInstall.Count mod(s) will be installed on server restart:</MudText>
                    @foreach (var mod in _applyResult.QueuedForInstall)
                    {
                        <MudText Typo="Typo.body2" Class="ml-3">‚Ä¢ @mod</MudText>
                    }
                </MudAlert>
            }
            
            @if (_applyResult.QueuedForRemoval.Count > 0)
            {
                <MudAlert Severity="Severity.Info" Class="mb-3">
                    <MudText Typo="Typo.subtitle2">üóëÔ∏è @_applyResult.QueuedForRemoval.Count mod(s) will be removed on server restart:</MudText>
                    @foreach (var mod in _applyResult.QueuedForRemoval)
                    {
                        <MudText Typo="Typo.body2" Class="ml-3">‚Ä¢ @mod</MudText>
                    }
                </MudAlert>
            }
            
            @if (_applyResult.Errors.Count > 0)
            {
                <MudAlert Severity="Severity.Error" Class="mb-3">
                    <MudText Typo="Typo.subtitle2">‚ùå Errors:</MudText>
                    @foreach (var error in _applyResult.Errors)
                    {
                        <MudText Typo="Typo.body2" Class="ml-3">‚Ä¢ @error</MudText>
                    }
                </MudAlert>
            }
            
            @if (_applyResult.AutoInstallerLaunched)
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">
                    <MudText Typo="Typo.subtitle2">üöÄ Auto-Installer Launched!</MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        A PowerShell window has opened that will automatically install the pending mods
                        when you stop the SPT server.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mt-2">
                        <strong>Just stop the server normally</strong> - the installer will detect it and complete the installation.
                    </MudText>
                </MudAlert>
            }
            else if (_applyResult.QueuedForInstall.Count > 0)
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    <MudText Typo="Typo.body2">
                        @(_applyResult.QueuedForInstall.Count) mod(s) queued for installation on next server restart.
                    </MudText>
                </MudAlert>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(() => _applyResultDialogVisible = false)">
            OK
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // State
    private bool _isApplying = false;
    private ApplyChangesResult? _applyResult;
    private bool _applyResultDialogVisible = false;

    // Add Mods Dialog (Bulk)
    private bool _addDialogVisible = false;
    private AddDialogStep _addDialogStep = AddDialogStep.Input;
    private string _bulkUrls = "";
    private bool _bulkOptional = false;
    private List<string> _urlsToProcess = new();
    private int _currentDownloadIndex = 0;
    private string? _currentDownloadUrl;
    private List<ModDownloadResult> _downloadResults = new();

    private enum AddDialogStep { Input, Downloading, Results }

    // Edit Mod Dialog
    private bool _editDialogVisible = false;
    private ModEntry? _editingMod = null;
    private string _editModName = "";
    private string _editDownloadUrl = "";
    private bool _editIsOptional = false;
    private List<InstallPathItem> _editInstallPaths = new();

    private class InstallPathItem
    {
        public string Source { get; set; } = "";
        public string Target { get; set; } = "";
    }

    // Apply Changes
    private async Task ApplyChanges()
    {
        _isApplying = true;
        StateHasChanged();

        try
        {
            _applyResult = await ModInstallService.ApplyPendingChangesAsync();
            _applyResultDialogVisible = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying changes: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isApplying = false;
            StateHasChanged();
        }
    }

    // Add Mods Dialog Methods
    private void OpenAddModsDialog()
    {
        _bulkUrls = "";
        _bulkOptional = false;
        _urlsToProcess = new();
        _downloadResults = new();
        _currentDownloadIndex = 0;
        _currentDownloadUrl = null;
        _addDialogStep = AddDialogStep.Input;
        _addDialogVisible = true;
    }

    private async Task ProcessBulkDownload()
    {
        _urlsToProcess = _bulkUrls
            .Split(new[] { '\n', '\r', ' ', '\t' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(u => u.Trim())
            .Where(u => !string.IsNullOrWhiteSpace(u) && (u.StartsWith("http://") || u.StartsWith("https://")))
            .Distinct()
            .ToList();

        if (_urlsToProcess.Count == 0)
        {
            Snackbar.Add("No valid URLs found. Please enter direct download links.", Severity.Warning);
            return;
        }

        _downloadResults = new();
        _currentDownloadIndex = 0;
        _addDialogStep = AddDialogStep.Downloading;
        await InvokeAsync(StateHasChanged);

        foreach (var url in _urlsToProcess)
        {
            _currentDownloadUrl = url;
            await InvokeAsync(StateHasChanged);

            try
            {
                var result = await ModDownloadService.DownloadAndAnalyzeModAsync(url);
                
                if (result.Success && string.IsNullOrWhiteSpace(result.ModName))
                {
                    result.ModName = ExtractModNameFromUrl(url);
                }

                _downloadResults.Add(result);

                if (result.Success && result.SuggestedInstallPaths.Count > 0)
                {
                    var mod = new ModEntry
                    {
                        ModName = result.ModName ?? ExtractModNameFromUrl(url),
                        DownloadUrl = url,
                        Optional = _bulkOptional,
                        LastUpdated = DateTime.UtcNow.ToString("o"),
                        InstallPaths = result.SuggestedInstallPaths,
                        Status = ModStatus.Pending // New mods start as pending
                    };
                    await ConfigService.AddModAsync(mod);
                }
            }
            catch (Exception ex)
            {
                _downloadResults.Add(new ModDownloadResult
                {
                    Url = url,
                    Success = false,
                    Error = ex.Message
                });
            }

            _currentDownloadIndex++;
            await InvokeAsync(StateHasChanged);
        }

        _addDialogStep = AddDialogStep.Results;
        await InvokeAsync(StateHasChanged);
    }

    private string ExtractModNameFromUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            var filename = Path.GetFileName(uri.LocalPath);
            
            var extensions = new[] { ".zip", ".7z", ".rar", ".tar.gz", ".tar", ".gz" };
            foreach (var ext in extensions)
            {
                if (filename.EndsWith(ext, StringComparison.OrdinalIgnoreCase))
                {
                    filename = filename.Substring(0, filename.Length - ext.Length);
                    break;
                }
            }
            
            return string.IsNullOrWhiteSpace(filename) ? "UnknownMod" : filename;
        }
        catch
        {
            return "UnknownMod";
        }
    }

    private void CloseAddDialog()
    {
        _addDialogVisible = false;
        _addDialogStep = AddDialogStep.Input;
        StateHasChanged();
    }

    // Edit Mod Dialog Methods
    private void EditMod(ModEntry mod)
    {
        _editingMod = mod;
        _editModName = mod.ModName;
        _editDownloadUrl = mod.DownloadUrl;
        _editIsOptional = mod.Optional;
        _editInstallPaths = mod.InstallPaths.Select(p => new InstallPathItem { Source = p[0], Target = p[1] }).ToList();
        _editDialogVisible = true;
    }

    private void AddEditInstallPath()
    {
        _editInstallPaths.Add(new InstallPathItem());
    }

    private void RemoveEditInstallPath(int index)
    {
        if (index >= 0 && index < _editInstallPaths.Count)
        {
            _editInstallPaths.RemoveAt(index);
        }
    }

    private async Task SaveEditMod()
    {
        if (_editingMod == null) return;

        _editingMod.ModName = _editModName;
        _editingMod.Optional = _editIsOptional;
        _editingMod.InstallPaths = _editInstallPaths.Select(p => new[] { p.Source, p.Target }).ToList();
        
        await ConfigService.SaveConfigAsync();
        Snackbar.Add($"Mod '{_editModName}' updated!", Severity.Success);
        CloseEditDialog();
    }

    private void CloseEditDialog()
    {
        _editDialogVisible = false;
        _editingMod = null;
        StateHasChanged();
    }

    // Reinstall Mod
    private async Task ReinstallMod(ModEntry mod)
    {
        var result = await DialogService.ShowMessageBox(
            "Reinstall Mod",
            $"This will re-download and reinstall '{mod.ModName}'. Continue?",
            yesText: "Reinstall", cancelText: "Cancel");

        if (result == true)
        {
            // Clear staging and re-download
            ConfigService.ClearStagingForUrl(mod.DownloadUrl);
            mod.Status = ModStatus.Pending;
            await ConfigService.SaveConfigAsync();
            
            // Trigger download
            var downloadResult = await ModDownloadService.DownloadAndAnalyzeModAsync(mod.DownloadUrl);
            if (downloadResult.Success)
            {
                Snackbar.Add($"Mod '{mod.ModName}' staged for reinstall. Click 'Apply Changes'.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Failed to download: {downloadResult.Error}", Severity.Error);
            }
            StateHasChanged();
        }
    }

    // Delete Mod
    private async Task DeleteMod(ModEntry mod)
    {
        if (mod.Status == ModStatus.Pending)
        {
            // Not yet installed - just remove from config
            var result = await DialogService.ShowMessageBox(
                "Remove Mod",
                $"Remove '{mod.ModName}' from the mod list? (It hasn't been installed yet)",
                yesText: "Remove", cancelText: "Cancel");

            if (result == true)
            {
                await ConfigService.RemovePendingModAsync(mod.DownloadUrl);
                Snackbar.Add($"Mod '{mod.ModName}' removed.", Severity.Warning);
                StateHasChanged();
            }
        }
        else
        {
            // Installed - mark for removal
            var result = await DialogService.ShowMessageBox(
                "Uninstall Mod",
                $"Mark '{mod.ModName}' for uninstallation? Files will be removed when you click 'Apply Changes'.",
                yesText: "Uninstall", cancelText: "Cancel");

            if (result == true)
            {
                await ConfigService.MarkModForRemovalAsync(mod.DownloadUrl);
                Snackbar.Add($"Mod '{mod.ModName}' marked for removal. Click 'Apply Changes' to uninstall.", Severity.Warning);
                StateHasChanged();
            }
        }
    }

    // Utility Methods
    private string TruncateUrl(string url)
    {
        if (url.Length <= 50) return url;
        return url.Substring(0, 25) + "..." + url.Substring(url.Length - 22);
    }

    private string FormatTimestamp(string timestamp)
    {
        if (DateTime.TryParse(timestamp, out var dt))
        {
            return dt.ToString("MMM dd, yyyy HH:mm");
        }
        return "Never";
    }

    private string GetModCardStyle(ModEntry mod)
    {
        var baseStyle = "background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; height: 100%;";
        
        return mod.Status switch
        {
            ModStatus.Pending => baseStyle + " border-left: 4px solid var(--accent-orange);",
            ModStatus.PendingRemoval => baseStyle + " border-left: 4px solid var(--accent-red); opacity: 0.7;",
            _ => baseStyle
        };
    }

    private string GetStatusChipStyle(ModStatus status)
    {
        return status switch
        {
            ModStatus.Installed => "background: var(--accent-green); color: #000;",
            ModStatus.Pending => "background: var(--accent-orange); color: #000;",
            ModStatus.PendingRemoval => "background: var(--accent-red); color: #fff;",
            _ => "background: var(--text-secondary); color: #000;"
        };
    }

    private string GetStatusText(ModStatus status)
    {
        return status switch
        {
            ModStatus.Installed => "Installed",
            ModStatus.Pending => "Pending Install",
            ModStatus.PendingRemoval => "Pending Removal",
            _ => "Unknown"
        };
    }
}
