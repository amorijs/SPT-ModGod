@page "/bewasmodsync"
@layout MainLayout

@using BewasModSync.Models
@using BewasModSync.Services
@using Color = MudBlazor.Color

@inject ConfigService ConfigService
@inject ModDownloadService ModDownloadService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <!-- Header Section -->
    <MudPaper Class="pa-6 mb-4" Style="background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 12px; margin-top: 55px;">
        <div class="d-flex justify-space-between align-center">
            <div>
                <MudText Typo="Typo.h4" Style="color: var(--text-primary); font-weight: 700;">Mod Management</MudText>
                <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">
                    Configure mods that will be synced to connected clients
                </MudText>
            </div>
            <MudButton Variant="Variant.Filled" 
                       StartIcon="@Icons.Material.Filled.Add" 
                       Color="Color.Primary"
                       Style="background: var(--accent-cyan); color: #000; font-weight: 600;"
                       OnClick="OpenAddModsDialog">
                Add Mods
            </MudButton>
        </div>
    </MudPaper>

    <!-- Stats Bar -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Extension" Style="color: var(--accent-cyan);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Total Mods</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Lock" Style="color: var(--accent-orange);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count(m => !m.Optional)</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Required</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: var(--accent-green);" Class="mr-3" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h4" Style="color: var(--text-primary);">@ConfigService.Config.ModList.Count(m => m.Optional)</MudText>
                        <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Optional</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Mod Cards -->
    @if (ConfigService.Config.ModList.Count == 0)
    {
        <MudPaper Class="pa-8 text-center" Style="background: var(--card-bg); border: 2px dashed var(--border-color); border-radius: 12px;">
            <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Large" Style="color: var(--text-secondary); font-size: 4rem;" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: var(--text-secondary);">No mods configured yet</MudText>
            <MudText Typo="Typo.body2" Style="color: var(--text-secondary);">Click "Add Mods" to get started</MudText>
        </MudPaper>
    }
    else
    {
        <MudGrid>
            @foreach (var mod in ConfigService.Config.ModList)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudPaper Class="pa-4" Style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; height: 100%;">
                        <div class="d-flex justify-space-between align-start mb-3">
                            <div>
                                <MudText Typo="Typo.h6" Style="color: var(--text-primary); font-weight: 600;">@mod.ModName</MudText>
                                <MudChip T="string" Size="Size.Small" 
                                         Style="@(mod.Optional ? "background: var(--accent-green); color: #000;" : "background: var(--accent-orange); color: #000;")">
                                    @(mod.Optional ? "Optional" : "Required")
                                </MudChip>
                            </div>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true">
                                <MudMenuItem OnClick="@(() => EditMod(mod))">
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-2" /> Edit
                                </MudMenuItem>
                                <MudMenuItem OnClick="@(() => ForceUpdateMod(mod))">
                                    <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" Class="mr-2" /> Force Update
                                </MudMenuItem>
                                <MudMenuItem OnClick="@(() => DeleteMod(mod))" Style="color: var(--accent-red);">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Class="mr-2" /> Delete
                                </MudMenuItem>
                            </MudMenu>
                        </div>

                        <MudText Typo="Typo.body2" Class="mono mb-2" Style="color: var(--text-secondary); word-break: break-all; font-size: 0.75rem;">
                            @TruncateUrl(mod.DownloadUrl)
                        </MudText>

                        <MudDivider Class="my-3" Style="border-color: var(--border-color);" />

                        <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            Updated: @FormatTimestamp(mod.LastUpdated)
                        </MudText>

                        <MudText Typo="Typo.caption" Class="mt-1 d-block" Style="color: var(--text-secondary);">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @mod.SyncPaths.Count sync path(s)
                        </MudText>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<!-- Add Mods Dialog (Bulk) -->
<MudDialog @bind-Visible="_addDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = false, BackdropClick = false })">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="color: var(--text-primary);">
            @if (_addDialogStep == AddDialogStep.Input)
            {
                <span>Add Mods</span>
            }
            else if (_addDialogStep == AddDialogStep.Downloading)
            {
                <span>Downloading Mods...</span>
            }
            else
            {
                <span>Results</span>
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_addDialogStep == AddDialogStep.Input)
        {
            <MudText Typo="Typo.body2" Class="mb-4" Style="color: var(--text-secondary);">
                Enter direct download links (one per line or separated by whitespace). 
                Mod names will be auto-generated from filenames.
            </MudText>
            
            <MudTextField @bind-Value="_bulkUrls" 
                          Label="Download URLs" 
                          Variant="Variant.Outlined"
                          Lines="8"
                          Placeholder="https://github.com/example/mod/releases/download/v1.0/ModName.zip&#10;https://github.com/another/mod.7z"
                          Class="mb-4 mono" />
            
            <MudCheckBox @bind-Value="_bulkOptional" 
                         Label="Mark all as optional (not enforced on clients)"
                         Color="Color.Primary" />
        }
        else if (_addDialogStep == AddDialogStep.Downloading)
        {
            <div class="pa-4">
                <MudText Typo="Typo.body1" Class="mb-2" Style="color: var(--text-primary);">
                    Processing @(_currentDownloadIndex + 1) of @_urlsToProcess.Count
                </MudText>
                <MudProgressLinear Value="@((_currentDownloadIndex + 1) * 100.0 / _urlsToProcess.Count)" 
                                   Color="Color.Primary" 
                                   Rounded="true" 
                                   Size="Size.Large"
                                   Class="mb-4" />
                
                <MudText Typo="Typo.body2" Class="mono" Style="color: var(--text-secondary); word-break: break-all;">
                    @(_currentDownloadUrl ?? "Starting...")
                </MudText>
                
                @if (_downloadResults.Count > 0)
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: var(--text-secondary);">
                        Completed: @_downloadResults.Count(r => r.Success) succeeded, @_downloadResults.Count(r => !r.Success) failed
                    </MudText>
                }
            </div>
        }
        else if (_addDialogStep == AddDialogStep.Results)
        {
            <div class="pa-2">
                @{ 
                    var successes = _downloadResults.Where(r => r.Success).ToList();
                    var failures = _downloadResults.Where(r => !r.Success).ToList();
                }
                
                @if (successes.Count > 0)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        Successfully added @successes.Count mod(s)
                    </MudAlert>
                    
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: var(--accent-green);">
                        ✓ Added Mods
                    </MudText>
                    <MudList T="string" Dense="true" Class="mb-4">
                        @foreach (var result in successes)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                                <MudText Style="color: var(--text-primary);">@result.ModName</MudText>
                                <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">
                                    @result.SuggestedSyncPaths.Count sync path(s) configured
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
                
                @if (failures.Count > 0)
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">
                        Failed to add @failures.Count mod(s)
                    </MudAlert>
                    
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: var(--accent-red);">
                        ✗ Failed Downloads
                    </MudText>
                    <MudList T="string" Dense="true">
                        @foreach (var result in failures)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                                <MudText Style="color: var(--text-primary); word-break: break-all; font-size: 0.85rem;">
                                    @TruncateUrl(result.Url)
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color: var(--accent-red);">
                                    @result.Error
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                }
            </div>
        }
    </DialogContent>
    <DialogActions>
        @if (_addDialogStep == AddDialogStep.Input)
        {
            <MudButton OnClick="CloseAddDialog" Variant="Variant.Text">Cancel</MudButton>
            <MudButton Color="Color.Primary" 
                       Variant="Variant.Filled"
                       Disabled="@(string.IsNullOrWhiteSpace(_bulkUrls))"
                       OnClick="ProcessBulkDownload">
                Download & Add
            </MudButton>
        }
        else if (_addDialogStep == AddDialogStep.Downloading)
        {
            <MudText Typo="Typo.caption" Style="color: var(--text-secondary);">
                Please wait...
            </MudText>
        }
        else if (_addDialogStep == AddDialogStep.Results)
        {
            <MudButton Color="Color.Primary" 
                       Variant="Variant.Filled"
                       OnClick="CloseAddDialog">
                Done
            </MudButton>
        }
    </DialogActions>
</MudDialog>

<!-- Edit Mod Dialog -->
<MudDialog @bind-Visible="_editDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6" Style="color: var(--text-primary);">Edit Mod</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_editModName" 
                      Label="Mod Name" 
                      Variant="Variant.Outlined"
                      Class="mb-4"
                      Required="true" />
        
        <MudTextField Value="@_editDownloadUrl" 
                      Label="Download URL" 
                      Variant="Variant.Outlined"
                      Class="mb-4 mono"
                      ReadOnly="true"
                      HelperText="URL cannot be changed. Delete and re-add to use a different URL." />
        
        <MudCheckBox @bind-Value="_editIsOptional" 
                     Label="Optional mod (not enforced on clients)"
                     Color="Color.Primary"
                     Class="mb-4" />

        <MudText Typo="Typo.subtitle1" Class="mt-4 mb-2" Style="color: var(--text-primary); font-weight: 600;">
            Sync Paths
        </MudText>
        
        @for (int i = 0; i < _editSyncPaths.Count; i++)
        {
            var index = i;
            <MudPaper Class="pa-3 mb-2" Style="background: var(--secondary-bg); border: 1px solid var(--border-color);">
                <MudGrid>
                    <MudItem xs="5">
                        <MudTextField @bind-Value="_editSyncPaths[index].Source" 
                                      Label="Source Path" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mono" />
                    </MudItem>
                    <MudItem xs="1" Class="d-flex align-center justify-center">
                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" />
                    </MudItem>
                    <MudItem xs="5">
                        <MudTextField @bind-Value="_editSyncPaths[index].Target" 
                                      Label="Target Path" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mono" />
                    </MudItem>
                    <MudItem xs="1" Class="d-flex align-center justify-center">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       OnClick="@(() => RemoveEditSyncPath(index))" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }

        <MudButton Variant="Variant.Text" 
                   StartIcon="@Icons.Material.Filled.Add" 
                   Color="Color.Primary"
                   OnClick="AddEditSyncPath"
                   Class="mt-2">
            Add Sync Path
        </MudButton>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseEditDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled"
                   Disabled="@(string.IsNullOrWhiteSpace(_editModName) || _editSyncPaths.Count == 0)"
                   OnClick="SaveEditMod">
            Save Changes
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    // Add Mods Dialog (Bulk)
    private bool _addDialogVisible = false;
    private AddDialogStep _addDialogStep = AddDialogStep.Input;
    private string _bulkUrls = "";
    private bool _bulkOptional = false;
    private List<string> _urlsToProcess = new();
    private int _currentDownloadIndex = 0;
    private string? _currentDownloadUrl;
    private List<ModDownloadResult> _downloadResults = new();

    private enum AddDialogStep { Input, Downloading, Results }

    // Edit Mod Dialog
    private bool _editDialogVisible = false;
    private ModEntry? _editingMod = null;
    private string _editModName = "";
    private string _editDownloadUrl = "";
    private bool _editIsOptional = false;
    private List<SyncPathItem> _editSyncPaths = new();

    private class SyncPathItem
    {
        public string Source { get; set; } = "";
        public string Target { get; set; } = "";
    }

    // Add Mods Dialog Methods
    private void OpenAddModsDialog()
    {
        _bulkUrls = "";
        _bulkOptional = false;
        _urlsToProcess = new();
        _downloadResults = new();
        _currentDownloadIndex = 0;
        _currentDownloadUrl = null;
        _addDialogStep = AddDialogStep.Input;
        _addDialogVisible = true;
    }

    private async Task ProcessBulkDownload()
    {
        // Parse URLs from the textarea (split by whitespace)
        _urlsToProcess = _bulkUrls
            .Split(new[] { '\n', '\r', ' ', '\t' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(u => u.Trim())
            .Where(u => !string.IsNullOrWhiteSpace(u) && (u.StartsWith("http://") || u.StartsWith("https://")))
            .Distinct()
            .ToList();

        if (_urlsToProcess.Count == 0)
        {
            Snackbar.Add("No valid URLs found. Please enter direct download links.", Severity.Warning);
            return;
        }

        _downloadResults = new();
        _currentDownloadIndex = 0;
        _addDialogStep = AddDialogStep.Downloading;
        await InvokeAsync(StateHasChanged);

        foreach (var url in _urlsToProcess)
        {
            _currentDownloadUrl = url;
            await InvokeAsync(StateHasChanged);

            try
            {
                var result = await ModDownloadService.DownloadAndAnalyzeModAsync(url);
                
                // Auto-generate mod name from URL filename
                if (result.Success && string.IsNullOrWhiteSpace(result.ModName))
                {
                    result.ModName = ExtractModNameFromUrl(url);
                }

                _downloadResults.Add(result);

                // If successful, add to config
                if (result.Success && result.SuggestedSyncPaths.Count > 0)
                {
                    var mod = new ModEntry
                    {
                        ModName = result.ModName ?? ExtractModNameFromUrl(url),
                        DownloadUrl = url,
                        Optional = _bulkOptional,
                        LastUpdated = DateTime.UtcNow.ToString("o"),
                        SyncPaths = result.SuggestedSyncPaths
                    };
                    await ConfigService.AddModAsync(mod);
                }
            }
            catch (Exception ex)
            {
                _downloadResults.Add(new ModDownloadResult
                {
                    Url = url,
                    Success = false,
                    Error = ex.Message
                });
            }

            _currentDownloadIndex++;
            await InvokeAsync(StateHasChanged);
        }

        _addDialogStep = AddDialogStep.Results;
        await InvokeAsync(StateHasChanged);
    }

    private string ExtractModNameFromUrl(string url)
    {
        try
        {
            var uri = new Uri(url);
            var filename = Path.GetFileName(uri.LocalPath);
            
            // Remove common extensions
            var extensions = new[] { ".zip", ".7z", ".rar", ".tar.gz", ".tar", ".gz" };
            foreach (var ext in extensions)
            {
                if (filename.EndsWith(ext, StringComparison.OrdinalIgnoreCase))
                {
                    filename = filename.Substring(0, filename.Length - ext.Length);
                    break;
                }
            }
            
            // Clean up common patterns like version numbers at the end
            // e.g., "ModName-v1.0.0" -> "ModName"
            // But keep simple names like "ModName1.0" as is
            
            return string.IsNullOrWhiteSpace(filename) ? "UnknownMod" : filename;
        }
        catch
        {
            return "UnknownMod";
        }
    }

    private void CloseAddDialog()
    {
        _addDialogVisible = false;
        _addDialogStep = AddDialogStep.Input;
        StateHasChanged();
    }

    // Edit Mod Dialog Methods
    private void EditMod(ModEntry mod)
    {
        _editingMod = mod;
        _editModName = mod.ModName;
        _editDownloadUrl = mod.DownloadUrl;
        _editIsOptional = mod.Optional;
        _editSyncPaths = mod.SyncPaths.Select(p => new SyncPathItem { Source = p[0], Target = p[1] }).ToList();
        _editDialogVisible = true;
    }

    private void AddEditSyncPath()
    {
        _editSyncPaths.Add(new SyncPathItem());
    }

    private void RemoveEditSyncPath(int index)
    {
        if (index >= 0 && index < _editSyncPaths.Count)
        {
            _editSyncPaths.RemoveAt(index);
        }
    }

    private async Task SaveEditMod()
    {
        if (_editingMod == null) return;

        // Update the mod in place
        _editingMod.ModName = _editModName;
        _editingMod.Optional = _editIsOptional;
        _editingMod.SyncPaths = _editSyncPaths.Select(p => new[] { p.Source, p.Target }).ToList();
        
        await ConfigService.SaveConfigAsync();
        Snackbar.Add($"Mod '{_editModName}' updated!", Severity.Success);
        CloseEditDialog();
    }

    private void CloseEditDialog()
    {
        _editDialogVisible = false;
        _editingMod = null;
        StateHasChanged();
    }

    // Other Actions
    private async Task ForceUpdateMod(ModEntry mod)
    {
        await ConfigService.UpdateModTimestampAsync(mod.DownloadUrl);
        Snackbar.Add($"Mod '{mod.ModName}' marked for update!", Severity.Info);
        StateHasChanged();
    }

    private async Task DeleteMod(ModEntry mod)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Mod",
            $"Are you sure you want to remove '{mod.ModName}' from the sync list?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            await ConfigService.RemoveModAsync(mod.DownloadUrl);
            Snackbar.Add($"Mod '{mod.ModName}' removed.", Severity.Warning);
            StateHasChanged();
        }
    }

    // Utility Methods
    private string TruncateUrl(string url)
    {
        if (url.Length <= 50) return url;
        return url.Substring(0, 25) + "..." + url.Substring(url.Length - 22);
    }

    private string FormatTimestamp(string timestamp)
    {
        if (DateTime.TryParse(timestamp, out var dt))
        {
            return dt.ToString("MMM dd, yyyy HH:mm");
        }
        return "Never";
    }
}
